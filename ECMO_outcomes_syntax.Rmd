---
title: "ECMO Chart Review"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

test

```{r}
library(dplyr)
library(summarytools)
library(tidyverse)
library(DescTools)
library(knitr)
library(kableExtra)
library(tableone)
library(pander)
library(sjPlot)
library(broom)
library(rms)
library(Hmisc)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library("DiagrammeR")
library(naniar)
library(ivprobit)
library(ggpubr)
panderOptions('table.split.table', Inf)
```


```{r}
#Import data
## convert the following variables to date before importing: kopiertes datum, ecmo einbau/ausbau, impella einbau/ausbau, krankenhaus aufnahme/entlassung, ITS aufnahme/entlassung, sterbetag
## convert to numeric: both EF variables

#all

library(readxl)
ecmo_all_campi <- read_excel("ecmo_data1_all_campi.xlsx", 
    col_types = c("numeric", "date", "text", 
        "text", "numeric", "text", "text", 
        "date", "date", "text", "text", "date", 
        "date", "text", "text", "date", "date", 
        "date", "date", "date", "text", "text", 
        "text", "text", "text", "text", "text", 
        "numeric", "numeric", "text", "text"))
View(ecmo_all_campi)

#CBF 2016-2019

library(readxl)
ecmo_cbf_2016_2019 <- read_excel("ecmo_data1_cbf_2016_2019.xlsx", 
    col_types = c("numeric", "date", "text", 
        "numeric", "numeric", "text", "text", 
        "date", "date", "text", "text", "date", 
        "date", "text", "text", "date", "date", 
        "date", "date", "date", "text", "text", 
        "text", "text", "text", "text", "text", 
        "numeric", "numeric", "text"))
View(ecmo_cbf_2016_2019)


#CBF 2013-2015

library(readxl)
ecmo_cbf_2013_2015 <- read_excel("ecmo_data1_cbf_2013_2015.xlsx", 
    col_types = c("numeric", "date", "numeric", 
        "numeric", "text", "text", "text", 
        "date", "date", "numeric", "text", 
        "date", "date", "text", "text", "date", 
        "date", "date", "date", "date", "numeric", 
        "text", "text", "text", "text", "text", 
        "text", "numeric", "numeric", "text"))
View(ecmo_cbf_2013_2015)

#CCM 2016-2019

library(readxl)
ecmo_ccm_2016_2019 <- read_excel("ecmo_data1_ccm_2016_2019.xlsx", 
    col_types = c("text", "date", "text", 
        "text", "numeric", "text", "text", 
        "date", "date", "text", "text", "date", 
        "date", "text", "text", "date", "date", 
        "date", "date", "date", "text", "text", 
        "text", "text", "text", "text", "text", 
        "numeric", "numeric", "text"))
View(ecmo_ccm_2016_2019)
```


```{r}
#code is obsolete
#drop data that has not been chart reviewed yet for ecmo_all_campi
#ecmo_all_campi2 <- ecmo_all_campi %>% filter(`Aus welcher Klinik` == "CBF" | `Aus welcher Klinik` == "CCM" | `Aus welcher Klinik` == "CVK/CCM")

ecmo_all_campi2 <- ecmo_all_campi %>% select(!"...31") #remove column on the right
```

```{r}
#append all datasets
ecmo_master1 <- rbind(ecmo_all_campi2, ecmo_cbf_2013_2015, ecmo_cbf_2016_2019, ecmo_ccm_2016_2019)

#drop duplicates
ecmo_mis <- which(!complete.cases(ecmo_master1$`ECMO ja/nein`)) #please control if this is a correct way to identify those duplicate patients
ecmo_master2 <- ecmo_master1[c(-ecmo_mis), ]

#why so many missings? check which patients were dropped

#check patient 313443437 and 	 312944303- multiple lines with information - some lines have no diagnoses???

#drop patients with protected PCI
ecmo_master2 <- ecmo_master2 %>% mutate(ppci = case_when((`Kommentar ECMO` == "PCI unter ECMO-Schutz" |
                                                           `Kommentar ECMO` == "PCI unter ECMOSchutz" |
                                                            `Kommentar ECMO` == "PCI unter ECMO-Support" |
                                                            `Kommentar ECMO` == "PCI unter ECMO Unterstützung  bei TAVI" |
                                                            `Kommentar Impella` == "PCI unter Impellaschutz" |
                                                            `Kommentar Impella` == "PCI unter Impellaschutz?" |
                                                            `Kommentar Impella` == "PCI unter PHP-Schutz" |
                                                            `Kommentar Impella` == "PCI mit Impellaschutz" |
                                                            `Kommentar Impella` == "PCI unter  Impellschutz" |
                                                            `Kommentar Impella` == "PCI unter Impellaschutz, unklar im AB" |
                                                             `Kommentar Impella` == "keine Erwähnung Impella, ist nur die Rede von PCI unter PHP-Schutz" 
                                                          ) ~ 1))
ecmo_master2$ppci[is.na(ecmo_master2$ppci)] <- 0

#please check if we included all protected PCIs with the text above

ecmo_master3 <- ecmo_master2 %>% filter(ppci == 0)

#several patients without diagnoses - please check
```


#clean data


```{r}
count(ecmo_master3, `Aus welcher Klinik`)

ecmo_master3 <- ecmo_master3 %>% mutate(campus = case_when(
  `Aus welcher Klinik` == "CBF" ~ 'cbf',
  `Aus welcher Klinik` == "CCM/CBF" ~ 'cbf',
  `Aus welcher Klinik` == "CVK/CBF" ~ 'cbf',
  `Aus welcher Klinik` == "CCM" ~ 'ccm',
   `Aus welcher Klinik` == "CVK" ~ 'cvk'))

campus <- ggplot(ecmo_master3, aes(x="", y= "", fill=campus)) +
   geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  theme_void()


#ECMO yes/no (could also have had impella!)

count(ecmo_master3, `ECMO ja/nein`)

ecmo_master3 <- ecmo_master3  %>% mutate(ecmo = case_when(
  `ECMO ja/nein` == "ja" ~ "VA-ECMO",
  `ECMO ja/nein` == "nein" ~ "No ECMO",
  `ECMO ja/nein` == "vv-ECMO" ~ "VV-ECMO",
  `ECMO ja/nein` == "HLM während TAVI?" ~ "Unclear",
   `ECMO ja/nein` == "keine Doku zur Ecmo?" ~ "Unclear"))

ecmo_master3 <- ecmo_master3  %>% mutate(ecmo_num = case_when(
  `ECMO ja/nein` == "ja" ~ "1",
  `ECMO ja/nein` == "nein" ~ "0",
  `ECMO ja/nein` == "vv-ECMO" ~ "2",
  `ECMO ja/nein` == "HLM während TAVI?" ~ ".",
   `ECMO ja/nein` == "keine Doku zur Ecmo?" ~ "."))
ecmo_master3$ecmo_num <- as.numeric(ecmo_master3$ecmo_num )

##check cases with "unclear"

ecmo <- ggplot(ecmo_master3, aes(x="", y= "", fill=ecmo)) +
   geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  theme_void()

#Impella yes/no

count(ecmo_master3, `Impella ja/nein`)

ecmo_master3 <- ecmo_master3  %>% mutate(impella = case_when(
  `Impella ja/nein` == "?" ~ "unclear",
  `Impella ja/nein` == "43249" ~ "unclear",
  `Impella ja/nein` == "aj" ~ "LV impella",
  `Impella ja/nein` == "ja" ~ "LV impella",
   `Impella ja/nein` == "nein" ~ "No impella",
  `Impella ja/nein` == "RV-Impella" ~ "RV impella",))

##check "unclear" and missings


ecmo_master3 <- ecmo_master3  %>% mutate(impella_num = case_when(
  `Impella ja/nein` == "?" ~ ".",
  `Impella ja/nein` == "43249" ~ ".",
  `Impella ja/nein` == "aj" ~ "1",
  `Impella ja/nein` == "ja" ~ "1",
   `Impella ja/nein` == "nein" ~ "0",
  `Impella ja/nein` == "RV-Impella" ~ "2",))
ecmo_master3$impella_num <- as.numeric(ecmo_master3$impella_num )


impella <- ggplot(ecmo_master3, aes(x="", y= "", fill=impella)) +
   geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  theme_void()


#ECMELLA yes/no

ecmo_master3 <- ecmo_master3 %>% mutate(ecmella = case_when((ecmo == "VA-ECMO" & impella == "LV impella") ~ 1))
ecmo_master3$ecmella[is.na(ecmo_master3$ecmella)] <- 0
ecmo_master3$ecmella <- as.logical(ecmo_master3$ecmella)

ecmella <- ggplot(ecmo_master3, aes(x="", y= "", fill=ecmella)) +
   geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  theme_void()

#ECMELLA vs. ECMO

ecmo_master3 <- ecmo_master3 %>% mutate(ec = case_when(ecmo == "VA-ECMO" & impella == "LV impella" ~ 1,
                                  ecmo == "VA-ECMO" & impella == "No impella" ~ 0))
ecmo_master3$ec <- as.logical(ecmo_master3$ec)

#mortality
ecmo_master3$mort <- as.character(ecmo_master3$`Sterbezeit (0 = nicht tot)`)
ecmo_master3$mort[ecmo_master3$mort == "1899-12-31 00:00:00"] <- 0
ecmo_master3$mort[!(ecmo_master3$mort == 0)] <- 1
ecmo_master3$mort <- as.numeric(ecmo_master3$mort)
ecmo_master3$mort <- as.logical(ecmo_master3$mort)

##check missings


#rea

count(ecmo_master3, `Reanimation: out-of-hospital (1) oder in-hospital (2) oder keine Reanimation (0)`)

ecmo_master3 <- ecmo_master3  %>% mutate(rea = case_when(
  `Reanimation: out-of-hospital (1) oder in-hospital (2) oder keine Reanimation (0)` == "0" ~ "No rea",
  `Reanimation: out-of-hospital (1) oder in-hospital (2) oder keine Reanimation (0)` == "?" ~ "unclear",
  `Reanimation: out-of-hospital (1) oder in-hospital (2) oder keine Reanimation (0)` == "0 (Kardioversion bei VT)" ~ "No rea",
  `Reanimation: out-of-hospital (1) oder in-hospital (2) oder keine Reanimation (0)` == "0.0" ~ "No rea",
   `Reanimation: out-of-hospital (1) oder in-hospital (2) oder keine Reanimation (0)` == "1" ~ "Out-of-hospital",
  `Reanimation: out-of-hospital (1) oder in-hospital (2) oder keine Reanimation (0)` == "1.0" ~ "Out-of-hospital",
  `Reanimation: out-of-hospital (1) oder in-hospital (2) oder keine Reanimation (0)` == "2" ~ "In-hospital",
  `Reanimation: out-of-hospital (1) oder in-hospital (2) oder keine Reanimation (0)` == "2.0" ~ "In-hospital",
  `Reanimation: out-of-hospital (1) oder in-hospital (2) oder keine Reanimation (0)` == "2 beim Ausladen aus dem Krankenwagen " ~ "In-hospital",))
##check missings


rea <- ggplot(ecmo_master3, aes(x="", y= "", fill=rea)) +
   geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  theme_void()


#years
ecmo_master3$year <- as.character(ecmo_master3$`Krankenhaus - Aufnahmezeit`)
ecmo_master3$year <- substr(ecmo_master3$year, 1, 4)
#check missings

year_ecmo <- ggplot(data = ecmo_master3, aes(x = year, y = ecmo_num, fill= campus)) +
    geom_bar(stat="identity")

year_impella <- ggplot(data = ecmo_master3, aes(x = year, y = impella_num, fill= campus)) +
    geom_bar(stat="identity")

year_ecmo_type <- ggplot(data = ecmo_master3, aes(x = year, y = ecmo_num, fill= ecmo)) +
    geom_bar(stat="identity")

year_ecmo_rea <- ggplot(data = ecmo_master3, aes(x = year, y = ecmo_num, fill= rea)) +
    geom_bar(stat="identity")

year_impella_type <- ggplot(data = ecmo_master3, aes(x = year, y = impella_num, fill= impella)) +
    geom_bar(stat="identity")

year_impella_rea <- ggplot(data = ecmo_master3, aes(x = year, y = impella_num, fill= rea)) +
    geom_bar(stat="identity")

graph <- ggarrange(year_ecmo, year_ecmo_type, year_ecmo_rea, year_impella, year_impella_type, year_impella_rea,
                    labels = c("1a. Frequency of ECMOs per hospital site", "1b. Frequency of ECMOs per ECMO type", "1c. Frequency of ECMOs per location of resuscitation",
                               "2a. Frequency of impellas per hospital site", "2b. Frequency of impellas per impella type",
                               "2c. Frequency of impellas per location of resuscitation"),
          ncol = 3, nrow = 2)




#diagnoses

#rename
ecmo_master3 <- rename(ecmo_master3, diag1 = `Diagnose 1 (bitte klar benennnen, noch nicht gruppieren)`)
ecmo_master3 <- rename(ecmo_master3, diag2 = `Diagnose 2`)
ecmo_master3 <- rename(ecmo_master3, diag3 = `Diagnose 3`)
ecmo_master3 <- rename(ecmo_master3, diag4 = `Diagnose 4`)

count(ecmo_master3, diag1)

ecmo_master3 <- ecmo_master3 %>% mutate(shockable = case_when((diag1 == "Kammerflimmern" |
                                                           diag1 == "Ventrikuläre Tachykardie" |
                                                           diag1 == "Pulslose ventrikuläre Tachykardie" |
                                                          diag1 == "Kammerflimmern/ Pulslose elektrische Aktivität" |
                                                            diag1 == "Kammerflimmern bzw. VT" |
                                                            diag1 == "Kammerflimmern und PEA" |
                                                            diag1 == "Kammerflimmern/ PEA" |
                                                            diag1 == "Kammerflimmern/ ventrikuläre Tachykardie" |
                                                            diag1 == "pulslose Ventrikuläre Tachykardie" |
                                                            diag1 == "Pulslose Ventrikuläre Tachykardie" |
                                                            diag1 == "pulslose Ventrikuläre Tachykardie /Kammerflimmern/Asystolie" |
                                                             diag1 == "ventrikuläre Tachykardie" |
                                                             diag1 == "Ventrikuläre Tachykardie/ Kammerflimmern" |
                                                             diag1 == "Ventrikuläre Tachykardien" |
                                                             diag1 == "VF" |
                                                            diag1 == "slow-VT" |
                                                             diag2 == "Pulslose ventrikuläre Tachykardie" |
                                                             diag2 == "Rezidivierende ventrikuläre Tachykardie" |
                                                             diag3 == "Adäquate Schockabgabe des CRT-D bei Ventrikulärer Tachykardie"
                                                          ) ~ 1))
ecmo_master3$shockable[is.na(ecmo_master3$shockable)] <- 0

ecmo_master3 <- ecmo_master3 %>% mutate(unshockable = case_when((diag1 == "Pulslose elektrische Aktivität" |
                                                           diag1 == "Asystolie" |
                                                             diag1 == "Asystolie unklarer Genese" |
                                                             diag1 == "PEA/Asystolie" |
                                                             diag1 == "	Pulslose Elektrische Aktivität" |
                                                             diag1 == "Pulslose elektrische Aktivität/ Kammerflimmern" |
                                                             diag1 == "Pulslose elektrische Aktivität/ Ventrikuläre Tachykardieo" |
                                                             diag1 == "Pulsloser elektrischer Aktivität"
                                                          ) ~ 1))
ecmo_master3$unshockable[is.na(ecmo_master3$unshockable)] <- 0


ecmo_master3 <- ecmo_master3 %>% mutate(stemi = case_when((diag1 == "STEMI der Vorderwand" |
                                                           diag1 == "STEMI" |
                                                           diag1 == "STEMI der Hinterwand" |
                                                          diag1 == "subakuter STEMI der Vorderwand" |
                                                            diag2 == "STEMI der Vorderwand" |
                                                            diag2== "STEMI" |
                                                            diag2== "STEMI der Hinterwand" |
                                                            diag2 == "STEMI der Seitenwand" |
                                                            diag2 == "subakuter STEMI der Vorderwand" |
                                                            diag2 == "akuter transmuraler Myokardinfarkt" |
                                                            diag2 == "akuter transmuraler Vorderwandinfarkt" |
                                                             diag2 == "inferiorer STEMI" |
                                                             diag2 == "STEMI-Äquivalent bei neu aufgetretenem Linksschenkelblock" |
                                                             diag2 == "STEMI mit Linksschenkelblock" |
                                                             diag2 == "subakuter STEMI" |
                                                            diag3 == "STEMI der Vorderwand" |
                                                             diag3 == "STEMI" |
                                                             diag3 == "STEMI der Hinterwand" |
                                                             diag3 == "subakuter STEMI der Seitenwand" |
                                                            diag3 == "subakuter STEMI der Vorderwand" |
                                                            diag3 == "akuter thrombotischer Verschluss der LCX" |
                                                            diag3 == "akuter transmuraler Hinterwandinfarkt" |
                                                            diag3 == "STEMI bei akut thrombotischem Verschluss der RCA" |
                                                            diag3 == "STEMI bei Hauptstammverschluss" |
                                                            diag3 == "STEMI der Vorderwamd" |
                                                            diag3 == "STEMI der Vorderwand und Seitenwand bei Hauptstammverschluss" |
                                                            diag3 == "STEMI der Vorderwand und Seitwand" |
                                                            diag3 == "STEMI mit Hauptstammverschluss" |
                                                            diag3 == "STEMI Vorderwand" |
                                                            diag3 == "subakuter ST-Hebungsinfarkt der Hinterwand" |
                                                            diag3 == "subakuter STEMI" |
                                                            diag4 == "STEMI" |
                                                            diag4 == "STEMI der Hinterwand"
                                                          ) ~ 1))
ecmo_master3$stemi[is.na(ecmo_master3$stemi)] <- 0


ecmo_master3 <- ecmo_master3 %>% mutate(nstemi = case_when((diag1 == "NSTEMI" |
                                                              diag2 == "NSTEMI" |
                                                              diag2 == "NSTEMI bei In-Stent-Thrombose" |
                                                              diag3 == "NSTEMI" |
                                                              diag3 == "NSTEMI der Seitenwand" |
                                                              diag3 == "NSTEMI bei HS-Beteiligung" |
                                                              diag3 == "NSTEMI der Vorderwand" |
                                                              diag4 == "NSTEMI"
                                                          ) ~ 1))
ecmo_master3$nstemi[is.na(ecmo_master3$nstemi)] <- 0


ecmo_master3 <- ecmo_master3 %>% mutate(mi = case_when((diag2 == "akuter Myokardinfarkt" |
                                                              diag2 == "Myokardinfarkt" |
                                                              diag2 == "subakuter Myokardinfarkt" |
                                                              diag2 == "subakuter Vorderwandinfarkt" |
                                                              diag2 == "subakuter Vorderwandinnfarkt" |
                                                              diag2 == "unklare AP-Beschwerden" |
                                                              diag2 == "akute myokardiale Ischämie" |
                                                              diag2 == "Stentthrombose RIVA" |
                                                          diag2 == "akute Stentthrombose" |
                                                              diag3 == "Myokardinfarkt" |
                                                              diag3 == "akuter Myokardinfarkt" |
                                                              diag3 == "akuter Myokardinfarkt bei Hauptstammverschluss" |
                                                              diag3 == "akuter Myokardinfarkt der Hinterwand" |
                                                          diag3 == "akuter Vorderwandinfarkt" |
                                                          diag3 == "Hauptstammverschluss" |
                                                          diag3 == "Hauptstammverschluss im Rahmen einer akuten Stentthrombose" |
                                                          diag3 == "Myokardinfarktes" |
                                                          diag3 == "perioperativer Vorderwandinfarkt" |
                                                          diag3 == "Seitenwandinfarkt" |
                                                          diag3 == "subakuter Rechtsherzinfarkt" |
                                                          diag3 == "Typ 2 Myokardinfarkt" |
                                                          diag3 == "Verschluss des Hauptstammes" |
                                                          diag3 == "Vorderwandinfarkt" |
                                                          diag3 == "akute Myokardischämie der Vorderwand" |
                                                          diag3 == "Stentthrombose" |
                                                          diag3 == "Thrombotische Hauptstammstenose" |
                                                          diag3 == "Typ IIa Myokardischämie" |
                                                          diag3 == "akute Verlegung der Koronargefäße" |
                                                          diag3 == "Ischämienachweis im Stressecho" |
                                                          diag4 == "kardiale Ischämie" |
                                                          diag4 == "Instabile Angina pectoris bei Koronarer Dreigefäßerkrankung" |
                                                          diag4 == "Koronare Herzerkrankung mit thrombotischem Verschluss des Hauptstammes/RIVA/RCX"
                                                          ) ~ 1))
ecmo_master3$mi[is.na(ecmo_master3$mi)] <- 0


ecmo_master3 <- ecmo_master3 %>% mutate(cs = case_when((diag1 == "kardiogener Schock" |
                                                          diag1 == "kardiogener und septischer Schock" |
                                                          diag1 == "Hypotonie" |
                                                          diag1 == "kardiogener und vasopleger Schock" |
                                                          diag2 == "kardiogener Schock" |
                                                          diag2 == "kardiogener und septischer Schock" |
                                                          diag2 == "kardiogener Schock mit Multiorganversagen" |
                                                          diag3 == "kardiogener Schock" |
                                                           diag4 == "kardiogener Schock" 
                                                          ) ~ 1))
ecmo_master3$cs[is.na(ecmo_master3$cs)] <- 0


ecmo_master3 <- ecmo_master3 %>% mutate(lae = case_when((diag2 == "beidseitige Lungenarterienembolie" |
                                                          diag2 == "Lungenarterienembolie" |
                                                           diag2 == "Embolisierung bei Vorhofflimmern" |
                                                           diag2 == "fulminante Lungenarterienembolie beidseits" |
                                                           diag2 == "Lungenarterienembolie links" |
                                                           diag2 == "zentrale Lungenarterienembolie beidseits" |
                                                           diag3 == "Lungenarterienembolie"
                                                          ) ~ 1))
ecmo_master3$lae[is.na(ecmo_master3$lae)] <- 0



ecmo_master3 <- ecmo_master3 %>% mutate(pul = case_when((diag1 == "ARDS" |
                                                             diag2 == "pneumogene Sepsis" |
                                                             diag2 == "Pneumonie" |
                                                             diag2 == "Hypoxie" |
                                                             diag2 == "respiratorische Globalinsuffizienz" |
                                                             diag3 == "Pneumonie" |
                                                            diag3 == "Pneumonie und ARDS" |
                                                           diag3 == "Stauungspneumonie" |
                                                            diag3 == "respiratorische Insuffizienz" |
                                                            diag3 == "akute respiratorische Insuffizienz" |
                                                            diag3 == "hypertensives Lungenödem" |
                                                           diag3 == "Lungenödem" |
                                                           diag3 == "Lungenödem"
                                                          ) ~ 1))
ecmo_master3$pul[is.na(ecmo_master3$pul)] <- 0



ecmo_master3 <- ecmo_master3 %>% mutate(khk = case_when((diag1 == "koronare Dreigefäßerkrankung" |
                                                           diag2 == "koronare Dreigefäßerkrankung" |
                                                           diag2 == "ischämische Kardiomyopathie" |
                                                           diag2 == "koronare Herzkrankheit" |
                                                           diag2 == "koronare Zweigefäßerkrankung" |
                                                           diag2 == "koronare Eingefäßerkrankung" |
                                                           diag2 == "Hauptstammstenose" |
                                                           diag2 == "koronare Herzerkrankung" |
                                                           diag3 == "koronare Dreigefäßerkrankung" |
                                                           diag3 == "koronare Zweigefäßerkrankung" |
                                                           diag3 == "ischämische Kardiomyopathie" |
                                                           diag3 == "koronare Eingefäßerkrankung" |
                                                           diag3 == "kornare Dreigefäßerkrankung" |
                                                            diag3 == "koronare Dreiefäßerkrankung" |
                                                            diag3 == "koronare Dreigefäßerkankung" |
                                                            diag3 == "KHK" |
                                                            diag3 == "koronare Herzerkrankung" |
                                                           diag4 == "koronare Dreigefäßerkrankung	" |
                                                           diag4 == "koronare Eingefäßerkrankung" |
                                                           diag4 == "koronare Zweigefäßerkrankung" |
                                                           diag4 == "ischämische Kardiomyopathie" |
                                                           diag4 == "KHK" |
                                                           diag4 == "koronare Eingefäßkrankheit" |
                                                           diag4 == "Koronare Zweigefäßerkrankung" |
                                                           diag4 == "subtotale Hauptstammstenose" |
                                                           diag4 == "Instabile Angina pectoris bei Koronarer Dreigefäßerkrankung"
                                                          ) ~ 1))
ecmo_master3$khk[is.na(ecmo_master3$khk)] <- 0

##chart review of all patients: coronary X vessel disease


ecmo_master3 <- ecmo_master3 %>% mutate(khk_num = case_when(diag2 == "koronare Eingefäßerkrankung"  | diag3 == "koronare Eingefäßerkrankung" |
                                                              diag4 == "koronare Eingefäßerkrankung" | diag4 == "koronare Eingefäßkrankheit" ~ 1,
                                  diag2 == "koronare Zweigefäßerkrankung" | diag3 == "koronare Zweigefäßerkrankung" | diag4 == "koronare Zweigefäßerkrankung" |
                                     diag4 == "Koronare Zweigefäßerkrankung" ~ 2,
                                  diag1 == "koronare Dreigefäßerkrankung" | diag2 == "koronare Dreigefäßerkrankung" | diag3 == "koronare Dreigefäßerkrankung" |
                                   diag3 == "kornare Dreigefäßerkrankung" |  diag3 == "koronare Dreiefäßerkrankung" | diag3 == "koronare Dreigefäßerkankung" |
                                    diag4 == "koronare Dreigefäßerkrankung" | diag4 == "Instabile Angina pectoris bei Koronarer Dreigefäßerkrankung" ~ 3))
ecmo_master3$khk_num <- as.ordered(ecmo_master3$khk_num)


ecmo_master3 <- ecmo_master3 %>% mutate(sepsis = case_when((diag1 == "Septischer Schock" |
                                                              diag1 == "septischer und kardiogener Schock" |
                                                              diag2 == "septische Kardiomypopathie" |
                                                              diag2 == "septischer Schock" |
                                                              diag3 == "septischer Schock" |
                                                              diag3 == "Toxic Shock Syndrom" |
                                                              diag3 == "V.a. Sepsis bei superinfizierter Stauungsdermatitis" |
                                                              diag3 == "pneumogene Sepsis" |
                                                              diag1 == "pneumogene Sepsis" |
                                                              diag1 == "septischer Schock" |
                                                              diag1 == "Urosepsis"
                                                          ) ~ 1))
ecmo_master3$sepsis[is.na(ecmo_master3$sepsis)] <- 0


ecmo_master3 <- ecmo_master3 %>% mutate(aortdiss = case_when((diag1 == "Aortendissektion Typ A" |
                                                              diag2 == "Typ-A-Dissektion der Aorta ascendens und descendens" |
                                                              diag2 == "Typ A-Dissektion der Aorta"
                                                          ) ~ 1))
ecmo_master3$aortdiss[is.na(ecmo_master3$aortdiss)] <- 0


ecmo_master3 <- ecmo_master3 %>% mutate(hi = case_when((diag1 == "akutes Herzversagen" |
                                                          diag1 == "biventrikuläres Herzversagen" |
                                                          diag1 == "Linksherzversagen" |
                                                          diag1 == "Low-Output-Failure" |
                                                          diag1 == "postoperatives myokardiales Pumpversagen" |
                                                          diag1 == "kardiale Dekompensation" |
                                                          diag2 == "kardiale Dekompensation" |
                                                          diag2 == "akute kardiale Dekompensation" |
                                                          diag2 == "low-cardiac-output-Syndrom" |
                                                          diag2== "akute Herzinsuffizienz" |
                                                          diag2 == "biventrikuläres Pumpversagen" |
                                                          diag2 == "Linksherzversagen" |
                                                          diag1 == "low-cardiac-outout-Syndrom" |
                                                          diag1 == "low cardiac output syndrom" |
                                                          diag1 == "Low Output Herzversagen" |
                                                          diag1 == "Rechtsherzversagen" |
                                                          diag3 == "kardiale Dekompensation" |
                                                          diag3 == "rezidivierende kardiale Dekompensation" |
                                                          diag3 == "biventrikuläre Dekompensation" |
                                                          diag3 == "dekompensierte Herzinsuffizienz" |
                                                          diag3 == "Rechtsherzversagen" |
                                                          diag3 == "globale Herzinsuffizienz" |
                                                          diag3 == "HEFrEF" |
                                                          diag3 == "Herzinsuffizienz" |
                                                          diag3 == "Herzinsuffizienz NYHA III-IV" |
                                                          diag3 == "Linksherzversagen" |
                                                          diag3 == "myokardiales Pumpversagen" |
                                                          diag4 == "akutes Linksherzversagen" |
                                                          diag4 == "Rechsherzversagen" |
                                                          diag4 == "kardiale Dekompensation	"
                                                          
                                                          ) ~ 1))
ecmo_master3$hi[is.na(ecmo_master3$hi)] <- 0


ecmo_master3 <- ecmo_master3 %>% mutate(myocarditis = case_when((diag1 == "Myokarditis" |
                                                                   diag2 == "akute lymphozytäre Myokarditis" |
                                                                   diag2 == "Eosinophile Myokarditis" |
                                                                   diag2 == "fulminante lymphozytäre Myokarditis" |
                                                                   diag2 == "fulminante Myokarditis" |
                                                                   diag2 == "V.a. Myokarditis" |
                                                                   diag3 == "Myokarditis" |
                                                                   diag4 == "Myokarditis"
                                                          ) ~ 1))
ecmo_master3$myocarditis[is.na(ecmo_master3$myocarditis)] <- 0



ecmo_master3 <- ecmo_master3 %>% mutate(intox = case_when((diag2 == "Eiben-Intoxikation" |
                                                             diag2 == "V.a. Intoxikation bei Drogenabusus" |
                                                             diag3 == "Alkoholentzugskrampf" |
                                                             diag3 == "Drogenabusus" |
                                                             diag3 == "Kokainabusus" 
                                                          ) ~ 1))
ecmo_master3$intox[is.na(ecmo_master3$intox)] <- 0




year_shockable <- ggplot(data = ecmo_master3, aes(x = year, y = shockable, fill= campus)) +
    geom_bar(stat="identity")

shockable_ecmo <- ggplot(data = ecmo_master3, aes(x = campus, y = shockable, fill= ecmo)) +
    geom_bar(stat="identity")

shockable_impella <- ggplot(data = ecmo_master3, aes(x = campus, y = shockable, fill= impella)) +
    geom_bar(stat="identity")


year_unshockable <- ggplot(data = ecmo_master3, aes(x = year, y = unshockable, fill= campus)) +
    geom_bar(stat="identity")

unshockable_ecmo <- ggplot(data = ecmo_master3, aes(x = campus, y = unshockable, fill= ecmo)) +
    geom_bar(stat="identity")

unshockable_impella <- ggplot(data = ecmo_master3, aes(x = campus, y = unshockable, fill= impella)) +
    geom_bar(stat="identity")



year_stemi <- ggplot(data = ecmo_master3, aes(x = year, y = stemi, fill= campus)) +
    geom_bar(stat="identity")

stemi_ecmo <- ggplot(data = ecmo_master3, aes(x = campus, y = stemi, fill= ecmo)) +
    geom_bar(stat="identity")

stemi_impella <- ggplot(data = ecmo_master3, aes(x = campus, y = stemi, fill= impella)) +
    geom_bar(stat="identity")



year_nstemi <- ggplot(data = ecmo_master3, aes(x = year, y = nstemi, fill= campus)) +
    geom_bar(stat="identity")

nstemi_ecmo <- ggplot(data = ecmo_master3, aes(x = campus, y = nstemi, fill= ecmo)) +
    geom_bar(stat="identity")

nstemi_impella <- ggplot(data = ecmo_master3, aes(x = campus, y = nstemi, fill= impella)) +
    geom_bar(stat="identity")


year_mi <- ggplot(data = ecmo_master3, aes(x = year, y = mi, fill= campus)) +
    geom_bar(stat="identity")

mi_ecmo <- ggplot(data = ecmo_master3, aes(x = campus, y = mi, fill= ecmo)) +
    geom_bar(stat="identity")

mi_impella <- ggplot(data = ecmo_master3, aes(x = campus, y = mi, fill= impella)) +
    geom_bar(stat="identity")


year_cs <- ggplot(data = ecmo_master3, aes(x = year, y = cs, fill= campus)) +
    geom_bar(stat="identity")

cs_ecmo <- ggplot(data = ecmo_master3, aes(x = campus, y = cs, fill= ecmo)) +
    geom_bar(stat="identity")

cs_impella <- ggplot(data = ecmo_master3, aes(x = campus, y = cs, fill= impella)) +
    geom_bar(stat="identity")



year_khk <- ggplot(data = ecmo_master3, aes(x = year, y = khk, fill= khk_num)) +
    geom_bar(stat="identity")

year_lae <- ggplot(data = ecmo_master3, aes(x = year, y = lae, fill= campus)) +
    geom_bar(stat="identity")


year_pul <- ggplot(data = ecmo_master3, aes(x = year, y = pul, fill= campus)) +
    geom_bar(stat="identity")

year_sepsis <- ggplot(data = ecmo_master3, aes(x = year, y = sepsis, fill= campus)) +
    geom_bar(stat="identity")


graph2 <- ggarrange(year_shockable, year_unshockable, year_stemi, year_nstemi, year_mi, year_khk, year_cs, year_lae, year_pul, year_sepsis,
                    labels = c("1a. Frequency of patients with shockable rhythm", "1b. Frequency of patients with unshockable rhythm",
                               "2a. Frequency of patients with STE-ACS", "2b. Frequency of patients with NSTE-ACS",
                               "3a. Frequency of patients with acute myocardial infarction (unspecified)",
                               "3b. Frequency of patients with X-coronary vessel disease",
                    "4a. Frequency of patients with cardiogenic shock",
                    "4b. Frequency of patients with pulmonary embolism",
                    "5a. Frequency of patients with pneumonia, respiratory failure or ARDS",
                    "5b. Frequency of patients with sepsis or septic shock"),
          ncol = 2, nrow = 5)

year_khk <- ggplot(data = ecmo_master3, aes(x = year, y = khk, fill= khk_num)) +
    geom_bar(stat="identity")

#ef

count(ecmo_master3, `LVEF Aufnahme`)

ecmo_master3$ef1 <- as.numeric(ecmo_master3$`LVEF Aufnahme`)
ecmo_master3$ef2 <- as.numeric(ecmo_master3$`LVEF Verlauf/Entlassung`)

bb1 <- ggplot(ecmo_master3, aes(y=ef1)) + 
  geom_boxplot()

bb2 <- ggplot(ecmo_master3, aes(y=ef2)) + 
  geom_boxplot()

bb1_rea <- ggplot(ecmo_master3, aes(y=ef1, color = rea)) + 
  geom_boxplot()

bb2_rea <- ggplot(ecmo_master3, aes(y=ef2, color = rea)) + 
  geom_boxplot()

bb1_stemi <- ggplot(ecmo_master3, aes(y=ef1, color = stemi)) + 
  geom_boxplot()

bb2_stemi <- ggplot(ecmo_master3, aes(y=ef2, color = stemi)) + 
  geom_boxplot()

bb1_nstemi <- ggplot(ecmo_master3, aes(y=ef1, color = nstemi)) + 
  geom_boxplot()

bb2_nstemi <- ggplot(ecmo_master3, aes(y=ef2, color = nstemi)) + 
  geom_boxplot()


graph_ef <- ggarrange(bb1, bb2, bb1_rea, bb2_rea, bb1_stemi, bb2_stemi, bb1_nstemi, bb2_nstemi,
                    labels = c("1a. LVEF at ICU admission", "1b. LVEF at ICU discharge",
                               "2a. LVEF at ICU admission by type of resuscitation", "2b. LVEF at ICU discharge by type of resuscitation",
                               "3a. LVEF at ICU admission in patients with STE-ACS", "3b. LVEF at ICU discharge in patients with STE-ACS",
                               "4a. LVEF at ICU admission in patients with NSTE-ACS", "4b. LVEF at ICU discharge in patients with NSTE-ACS"),
          ncol = 2, nrow = 4)

#provider

##chart review of remaining providers

#rosc
##check NA for no rea vs. NA for missing

ecmo_master3 <- rename(ecmo_master3, rosc = `ROSC bei ANSCHLUSS: Ja (1) /nein (0) / keine Reanimation (NA)`)

n <- count(ecmo_master3, rosc)

ecmo_master3 <- ecmo_master3 %>% mutate(rosc_num = case_when(rosc == "NA"  | rosc == "1" | rosc == "1?" |
                                                     rosc == "(AB klingt wie ROSC, Katheterprotokoll: periterventionelle Reanimation)" ~ "1",
                                                     
                                  rosc == "0" |
                                  rosc == "0 - primär Anschluss an HLM währen Kreislaufstillstand" | 
                                    rosc == "0 \"Anlage der CARDIOHELP durch Wechsel der arteriellen  Schleuse in der linken Leiste und der venösen Schleuse der rechten Leiste. Dabei Kammerflimmern, welches sich  nicht durch Defibrillation terminieren lässt.. \""  ~ "0",
                                  
                                    rosc == "kein Anschluss" |
                                  rosc == "unklar" | rosc == "?" | rosc == "intermettierende Reanimation" |
                                    rosc == "kein Protokoll" | rosc == "unklar - rezidivierend reanimationspflichtig" |
                                    rosc == "unklar \"bei weiter bestehender rhytmologischer Instabilität Entschluss zur Anlage einer ECMO\"" |
                                    rosc == "unklar \"unter kontinuerlicher Katecholamigabe sowie Impellaimplantation stabilisierten sich die Kreislaufverhältnisse im Verlauf\"" | rosc == "unklar, nach OP Protokoll denke ich 0" ~ "."))

ecmo_master3$rosc_num[ecmo_master3$rea == "No rea"] <- 1 #If no rea happened, then there was ROSC at Anschluss
ecmo_master3$rosc_num[(ecmo_master3$rea == "Out-of-hospital" | ecmo_master3$rea == "In-hospital") & ecmo_master3$rosc == "NA"] <- "."

#check all patients where rosc is NA
rea <- ecmo_master3 %>% select(`Reanimation: out-of-hospital (1) oder in-hospital (2) oder keine Reanimation (0)`, rea, rosc, rosc_num)

ecmo_master3$rosc_num <- as.numeric(ecmo_master3$rosc_num)
```

#lenght of stay

```{r}
##length of stay 
ecmo_master3$admission<- as.Date(ecmo_master3$`Krankenhaus - Aufnahmezeit`)
ecmo_master3$discharge<- as.Date(ecmo_master3$`Krankenhaus - Entlassungszeit`)

ecmo_master3$length_of_stay <-difftime( ecmo_master3$discharge, ecmo_master3$admission, unit="days") 

n <-count(ecmo_master3, length_of_stay)
#3 errors in data in negative direction , 1 in positive direction

##ICU length of stay
ecmo_master3$ICU_admission<- as.Date(ecmo_master3$`ITS - Aufnahmezeit`)
ecmo_master3$ICU_discharge<- as.Date(ecmo_master3$`ITS - Entlassungszeit`)

ecmo_master3$ICU_length_of_stay <-difftime( ecmo_master3$ICU_discharge, ecmo_master3$ICU_admission, unit="days") 

n <-count(ecmo_master3, ICU_length_of_stay)

#7 errors in data in negative correction, 3 in positive direction 

##ECMELLA time overlap

#only date
ecmo_master3$ecmo_implantation <- as.Date(ecmo_master3$`ECMO wann eingebaut?`)
ecmo_master3$impella_implantation <- as.Date(ecmo_master3$`Impella wann eingebaut?`)

#1. was impella implantation during ecmo ?

ecmo_master3$ecmo_interval <- interval(ecmo_master3$ecmo_implantation, ecmo_master3$`ECMO wann ausgebaut?`) #create time interval
ecmo_master3$impella_during_ecmo <- ecmo_master3$impella_implantation %within% ecmo_master3$ecmo_interval #test if impella implantation was during ecmo 

#see how many test negative and why 
n <- ecmo_master3 %>% filter(impella_during_ecmo==F)


#2. was ecmo implantation during impella? same procedure

ecmo_master3$impella_interval <- interval(ecmo_master3$impella_implantation, ecmo_master3$`Impella wann ausgebaut?`) #create time interval
ecmo_master3$ecmo_during_impella <- ecmo_master3$ecmo_implantation %within% ecmo_master3$impella_interval

#3. create variable that covers both 
ecmo_master3$ecmella_true <- ifelse(ecmo_master3$ecmo_during_impella==T | ecmo_master3$impella_during_ecmo==T, 
                                    TRUE, FALSE)

#check patients that are exlucded
n <- ecmo_master3 %>% filter(ecmella_true==F)

#1 patient is wrongfully excluded, possibly because impella explantation date is still missing in data -> manually corrected
ecmo_master3 <- ecmo_master3 %>% mutate(ecmella_true= replace(ecmella_true,
                                                    which((Fallnumer=="313994605" & ecmella_true==F)), T))

#final ecmella definition --> make sure only VA-ECMO and LV-Impella are included in variable
ecmo_master3$ecmella_final <- ifelse(ecmo_master3$ecmella_true==T & ecmo_master3$ecmo=="VA-ECMO" & ecmo_master3$impella=="LV impella", 
                                     TRUE, FALSE)
count(ecmo_master3, ecmella_final)

n <- ecmo_master3 %>% filter(ecmella_true==T & ecmella_final==F)

```

















```{r}
#check for mortality results

xtabs(~mort+ec,data=ecmo_master3)

mort <- ggplot(ecmo_master3, aes(ec, mort)) +
        geom_boxplot()

t.test(mort + ec, data = ecmo_master3)

ecmo_master3_rea <- ecmo_master3 %>% filter(rea == "In-hospital" | rea == "Out-of-hospital")

log_mort <- glm(mort ~ ec,
          data = ecmo_master3_rea, family = "binomial")
summary(log_mort)

exp(cbind(OR = coef(log_mort), confint(log_mort)))
```
